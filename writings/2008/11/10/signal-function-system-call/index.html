<!DOCTYPE html>
<!--[if IE 9]><html class="lt-ie10" lang="zh-cmn-Hans" > <![endif]-->
<html class="no-js" lang="zh-cmn-Hans" >

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>signal(sig, function) 系统调用 | r.4ntix Blue's Noise Player</title>

  <link rel="stylesheet" href="http://antix.blue/theme/css/normalize.css">
  <link rel="stylesheet" href="http://antix.blue/theme/css/foundation.min.css">
  <link rel="stylesheet" href="http://antix.blue/theme/css/typo.css">
  <link rel="stylesheet" href="http://antix.blue/theme/css/pygments.css">
  <link rel="stylesheet" href="http://antix.blue/theme/css/app.css">

  <script src="http://antix.blue/theme/js/vendor/modernizr.js"></script>
</head>

<body>
  <!-- start of header -->
  <header class="contain-to-grid">
    <nav class="top-bar" data-topbar>
      <ul class="title-area">
        <li class="name">
          <h1><a href="http://antix.blue">r.4ntix Blue's Noise Player</a></h1>
        </li>
        <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
      </ul>
      <section class="top-bar-section">
        <!-- Right Nav Section -->
        <ul class="right">
          <li><a href="http://antix.blue/about/">About</a></li>
          <li>
            <a href="#">|</a>
          </li>
          <li><a href="https://instagram.com/r4ntix">Instagram</a></li>
          <li><a href="https://twitter.com/r4ntix">Twitter</a></li>
          <li><a href="https://plus.google.com/112109872395334308066">Google+</a></li>
        </ul>
      </section>
    </nav>
  </header>
  <!-- end of header -->

  <!-- start of content -->
  <div id="content" class="row">
    <div class="medium-9 large-10 columns">
      <div class="article typo textwrap">
        <h1 class="serif">signal(sig, function) 系统调用</h1>
        <!--  -->
<p>在这星期《操作系统实验指导》上看到了这样一个系统调用：<code class="c"><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span></code>，呵呵，很好奇，因为每次这课的系统调用都说得很不清楚，连函数原型也没有。所以导致很多同学写的(也可能是抄的..)程序编译不成功，即使编译成功了程序也出错。</p>
<p>于是翻了翻书，书上说这个系统调用的函数原型是 <code class="c"><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">signal</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="p">(</span><span class="kt">int</span><span class="p">);</span></code>，更是一惊，这样的函数原型在学校这种SB 课本上是很少见的，可能有些同学看都看不懂，更别说，好好的调用了。当然 <code class="c"><span class="o">&lt;</span><span class="n">signal</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span></code> 头文件(跟进去看看就知道了，老外还真细心)为代码用户解决了 <code class="c"><span class="n">conversion</span> <span class="n">from</span> <span class="err">‘</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="err">’</span> <span class="n">to</span> <span class="err">’</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="err">’</span></code> 这样的问题，虽然能成功编译文件，但编译时照样会出现警告！</p>
<p>当然如果你认为“警告”无关紧要的话，你就去死吧。0 warning，0 error ，才是我的追求。</p>
<p><code class="c"><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">signal</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="p">(</span><span class="kt">int</span><span class="p">);</span></code> 的原型其实是这样的 <code class="c"><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">);</span></code>，有点熟悉了吧？再深入一点 <code class="c"><span class="n">signal</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">));</span></code>，会引出一个问题，如果 <code class="c"><span class="o">*</span><span class="n">func</span></code> 函数是 <code class="c"><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span></code> 的怎么办？很多人一不小心就会写成这样。需要强制转换对吧？应该出现ERROR，但为什么，还能编译成功呢？进去 <code class="c"><span class="o">&lt;</span><span class="n">signal</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span></code> 头文件看看，在75行：</p>
<div class="highlight"><pre><span class="cm">/* Type of a signal handler.  */</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="kt">__sighandler_t</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">__sighandler_t</span> <span class="n">__sysv_signal</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__sig</span><span class="p">,</span> <span class="kt">__sighandler_t</span> <span class="n">__handler</span><span class="p">)</span>
  <span class="n">__THROW</span><span class="p">;</span>
</pre></div>
<p>原来人家都把强制转换做好了的。
我们也可以这样，显示的强制转换：</p>
<div class="highlight"><pre><span class="n">signal</span> <span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span><span class="n">func</span><span class="p">);</span>
<span class="cm">/* 或者可读性好一些的：*/</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="kt">func_t</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">signal</span> <span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="p">(</span><span class="kt">func_t</span><span class="p">)</span><span class="n">func</span><span class="p">);</span>
</pre></div>
<p>好了，现在来对这个typedef 进行理解吧，直接看《THE C PROGRAMMING LANGUAGE》 Page.147</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">PFI</span><span class="p">)</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * creates the type PFI, for &#39;&#39;pointer to function (of two char * arguments) returning int,&#39;&#39; which can be used in contexts like</span>
<span class="cm"> * PFI strcmp, numcmp;</span>
<span class="cm"> */</span>
</pre></div>
<p>现在应该完全理解这个 <code class="c"><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span></code> 系统调用了吧。</p>

      </div>
    </div>
    <div class="hide-for-small-only medium-3 large-2 columns">
      <ul class="side-nav">
        <li><time datetime="2008-11-10T00:00:00+08:00" class="serif">2008年11月10日</time></li>
        <li class="divider"></li>
        <li><span class="serif">Written by</span> <a href="#">r.4ntix Shawn</a></li>
        <li class="divider"></li>
        <li><span class="serif">Categories</span> <a href="#">Writings</a></li>
        <li class="divider"></li>
        <li><span class="serif">Tags</span> <a href="#">c</a> <a href="#">program</a> </li>
      </ul>
    </div>
  </div>
  <!-- end of content -->

  <!-- start of footer -->
  <footer class="row">
    <div class="small-6 medium-6 large-6 columns">
      <small>
        Designed and Created(2005-2015) by <a href="http://antix.blue/about/">r.4ntix Blue</a>
        <br />
        ✎ Time waits for no one.
      </small>
    </div>
    <div class="small-6 medium-6 large-6 columns">
      <small class="right">
        Help from <a href="http://blog.getpelican.com/">Pelican</a> and <a href="http://foundation.zurb.com/">Foundation 5</a> and <a href="https://github.com/sofish/typo.css">Typo.css</a>
        <br />
        ☂ Hosting on <a href="https://github.com/">GitHub</a> and <a href="https://gitcafe.com/">GitCafe</a>
      </small>
    </div>
  </footer>
  <!-- end of footer -->

  <script src="http://antix.blue/theme/js/vendor/jquery.js"></script>
  <script src="http://antix.blue/theme/js/foundation.min.js"></script>
  <script>
    $(document).foundation();
  </script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47845863-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>

</html>